name: CI-CD (WSL)

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, x64]

    env:
      COMPOSE_FILE: Booking-Project-fullstack/docker-compose.yml

    steps:
      # -------------------------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2Ô∏è‚É£ Verify project structure (safety check)
      # -------------------------------------------------
      - name: Verify project structure
        run: |
          ls Booking-Project-fullstack
          ls Booking-Project-fullstack/booking-ui
          ls Booking-Project-fullstack/Accomodation-Booking-OTA
          ls Booking-Project-fullstack/nginx

      # -------------------------------------------------
      # 3Ô∏è‚É£ Cache Maven (backend)
      # -------------------------------------------------
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('Booking-Project-fullstack/Accomodation-Booking-OTA/**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # -------------------------------------------------
      # 4Ô∏è‚É£ Cache npm (frontend)
      # -------------------------------------------------
      - name: Cache npm modules
        uses: actions/cache@v4
        with:
          path: Booking-Project-fullstack/booking-ui/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('Booking-Project-fullstack/booking-ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # -------------------------------------------------
      # 5Ô∏è‚É£ Generate backend .env
      # -------------------------------------------------
      - name: Generate backend .env
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: Booking-Project-fullstack/Accomodation-Booking-OTA/.env
          contents: |
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}

            JWT_BASE64_SECRET=${{ secrets.JWT_BASE64_SECRET }}
            JWT_ACCESS_TOKEN_VALIDITY_IN_SECONDS=${{ secrets.JWT_ACCESS_TOKEN_VALIDITY_IN_SECONDS }}
            JWT_REFRESH_TOKEN_VALIDITY_IN_SECONDS=${{ secrets.JWT_REFRESH_TOKEN_VALIDITY_IN_SECONDS }}

            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}

            SPRING_MAIL_USERNAME=${{ secrets.SPRING_MAIL_USERNAME }}
            SPRING_MAIL_PASSWORD=${{ secrets.SPRING_MAIL_PASSWORD }}

            VNPAY_TMN_CODE=${{ secrets.VNPAY_TMN_CODE }}
            VNPAY_HASH_SECRET=${{ secrets.VNPAY_HASH_SECRET }}

      # -------------------------------------------------
      # 6Ô∏è‚É£ Build backend Docker image (SINGLE LINE ‚úÖ)
      # -------------------------------------------------
      - name: Build backend image
        run: docker build -f Booking-Project-fullstack/Accomodation-Booking-OTA/Dockerfile -t booking-backend:latest Booking-Project-fullstack

      # -------------------------------------------------
      # 7Ô∏è‚É£ Build frontend Docker image (SINGLE LINE ‚úÖ)
      # -------------------------------------------------
      - name: Build frontend image
        run: docker build -f Booking-Project-fullstack/booking-ui/Dockerfile -t booking-frontend:latest Booking-Project-fullstack

      # -------------------------------------------------
      # 8Ô∏è‚É£ Deploy with Docker Compose
      # -------------------------------------------------
      - name: Deploy with Docker Compose
        run: |
          docker compose -f Booking-Project-fullstack/docker-compose.yml down --remove-orphans
          docker compose -f Booking-Project-fullstack/docker-compose.yml up -d --build

      # -------------------------------------------------
      # 9Ô∏è‚É£ Health check
      # -------------------------------------------------
      - name: Verify services are healthy
        run: |
          sleep 10
          curl -f http://localhost:8080/actuator/health

      # -------------------------------------------------
      # üîü Cleanup
      # -------------------------------------------------
      - name: Prune unused images
        if: always()
        run: docker image prune -f
