name: CI‑CD (WSL)

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, x64]

    env:
      # Optional: set a default compose file location
      COMPOSE_FILE: docker-compose.yml

    steps:
      # -------------------------------------------------
      # 1️⃣ Checkout source
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2️⃣ Cache Maven (backend) dependencies
      # -------------------------------------------------
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('Accomodation-Booking-OTA/**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # -------------------------------------------------
      # 3️⃣ Cache npm (frontend) dependencies
      # -------------------------------------------------
      - name: Cache npm modules
        uses: actions/cache@v4
        with:
          path: booking-ui/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('booking-ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # -------------------------------------------------
      # 4️⃣ Create .env for the backend
      # -------------------------------------------------
      - name: Generate backend .env
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: Accomodation-Booking-OTA/.env
          contents: |
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}

            JWT_BASE64_SECRET=${{ secrets.JWT_BASE64_SECRET }}
            JWT_ACCESS_TOKEN_VALIDITY_IN_SECONDS=${{ secrets.JWT_ACCESS_TOKEN_VALIDITY_IN_SECONDS }}
            JWT_REFRESH_TOKEN_VALIDITY_IN_SECONDS=${{ secrets.JWT_REFRESH_TOKEN_VALIDITY_IN_SECONDS }}

            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}

            SPRING_MAIL_USERNAME=${{ secrets.SPRING_MAIL_USERNAME }}
            SPRING_MAIL_PASSWORD=${{ secrets.SPRING_MAIL_PASSWORD }}

            VNPAY_TMN_CODE=${{ secrets.VNPAY_TMN_CODE }}
            VNPAY_HASH_SECRET=${{ secrets.VNPAY_HASH_SECRET }}

      # -------------------------------------------------
      # 5️⃣ Build backend Docker image
      # -------------------------------------------------
      - name: Build backend image
        working-directory: Accomodation-Booking-OTA
        run: |
          docker build -t booking-backend:latest .

      # -------------------------------------------------
      # 6️⃣ Build frontend Docker image
      # -------------------------------------------------
      - name: Build frontend image
        working-directory: booking-ui
        run: |
          docker build -f booking-ui/Dockerfile -t booking-frontend:latest .

      # -------------------------------------------------
      # 7️⃣ Bring the whole stack up with Docker‑Compose
      # -------------------------------------------------
      - name: Deploy with Docker Compose
        run: |
          docker compose -f ${{ env.COMPOSE_FILE }} down --remove-orphans
          docker compose -f ${{ env.COMPOSE_FILE }} up -d --build

      # -------------------------------------------------
      # 8️⃣ Simple health‑check (optional but useful)
      # -------------------------------------------------
      - name: Verify services are healthy
        run: |
          # Wait a few seconds for containers to start
          sleep 10
          # Example: check that the Spring Boot app returns 200
          curl -f http://localhost:8080/actuator/health || exit 1

      # -------------------------------------------------
      # 9️⃣ Clean up (optional)
      # -------------------------------------------------
      - name: Prune unused images
        if: always()
        run: docker image prune -f